services:
  keycloak_db:
    image: postgres:16-alpine
    container_name: keycloak_db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5  
    networks:
        - microservices-net  
  keycloak:
      image: quay.io/keycloak/keycloak:26.5.2
      container_name: keycloak
      command: start-dev
      environment:
        # Настройки БД
        KC_DB: postgres
        KC_DB_URL: jdbc:postgresql://keycloak_db:5432/keycloak
        KC_DB_USERNAME: keycloak
        KC_DB_PASSWORD: password
        # Админ панель
        KC_BOOTSTRAP_ADMIN_USERNAME: admin
        KC_BOOTSTRAP_ADMIN_PASSWORD: admin
        # Важно для работы с localhost в разработке
        KC_HOSTNAME_STRICT: "false"
        KC_HTTP_ENABLED: "true"
      ports:
        - "8080:8080"
      depends_on:
        keycloak_db:
          condition: service_healthy
      networks:
        - microservices-net
    
  discovery:
    build:
      context: ./discovery-service
      dockerfile: Dockerfile
    image: mycompany/discovery-service:latest
    container_name: discovery
    ports:
      - "8761:8761"
    hostname: discovery
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/
      - JAVA_OPTS=-Xms256m -Xmx512m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - microservices-net

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    image: mycompany/api-gateway:latest
    container_name: gateway
    ports:
      - "8085:8085"          
    depends_on:
      discovery:
        condition: service_healthy
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/
      - SPRING_CLOUD_GATEWAY_DISCOVERY_LOCATOR_ENABLED=false   # если перешёл на ручные routes
      - JAVA_OPTS=-Xms256m -Xmx768m
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=http://keycloak:8080/realms/microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
        - microservices-net
    

# ------- USER-SERVICE

  user-service:
      build:
        context: ./user-service
        dockerfile: Dockerfile
      image: mycompany/user-service:latest
      container_name: user-service
      restart: unless-stopped
      depends_on:
        discovery:
          condition: service_healthy
        user-db:
          condition: service_healthy
      environment:
        - SPRING_DATASOURCE_URL=jdbc:postgresql://user-db:5432/userdb
        - SPRING_DATASOURCE_USERNAME=useruser
        - SPRING_DATASOURCE_PASSWORD=userpass123
        - SPRING_JPA_HIBERNATE_DDL_AUTO=update
        - SERVER_PORT=0
        - EUREKA_INSTANCE_INSTANCE_ID=user-service:instance-1
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/
        - SPRING_APPLICATION_NAME=user-service
        - JAVA_OPTS=-Xms256m -Xmx512m
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
        interval: 15s
        timeout: 5s
        retries: 4
        start_period: 30s
      labels:
        - "logging=promtail"
      networks:
        - microservices-net

  user-db:
      image: postgres:16-alpine
      container_name: user-db
      restart: unless-stopped
      environment:
        POSTGRES_USER: useruser
        POSTGRES_PASSWORD: userpass123
        POSTGRES_DB: userdb
      ports:
        - "54321:5432"          # внешний порт для удобства подключения из IDE
      volumes:
        - user-db-data:/var/lib/postgresql/data
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U useruser -d userdb"]
        interval: 5s
        timeout: 5s
        retries: 5
        start_period: 10s
      networks:
        - microservices-net

# -------- ORDER-SERVICE -----

  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    image: mycompany/order-service:latest
    container_name: order-service
    depends_on:
      discovery:
        condition: service_healthy
      order-db:
          condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://order-db:5432/orderdb
      - SPRING_DATASOURCE_USERNAME=orderuser
      - SPRING_DATASOURCE_PASSWORD=orderpass456
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=0
      - EUREKA_INSTANCE_INSTANCE_ID=order-service:instance-1
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/
      - SPRING_APPLICATION_NAME=order-service
      - JAVA_OPTS=-Xms256m -Xmx512m
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_DEV_FOLOMKIN=DEBUG
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]   # или /health, если actuator не включён
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s     # даём время на старт и миграции
    labels:
      - "logging=promtail"
    networks:
      - microservices-net

  order-db:
    image: postgres:16-alpine
    container_name: order-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: orderuser
      POSTGRES_PASSWORD: orderpass456
      POSTGRES_DB: orderdb
    ports:
      - "54322:5432"          # другой внешний порт, чтобы не конфликтовать
    volumes:
      - order-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orderuser -d orderdb"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
        - microservices-net

  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    image: mycompany/payment-service:latest
    container_name: payment-service
    depends_on:
      discovery:
        condition: service_healthy
      payment-db:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://payment-db:5432/paymentdb
      - SPRING_DATASOURCE_USERNAME=paymentuser
      - SPRING_DATASOURCE_PASSWORD=paymentpass456
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=0
      - EUREKA_INSTANCE_INSTANCE_ID=payment-service:instance-1
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/
      - SPRING_APPLICATION_NAME=payment-service
      - JAVA_OPTS=-Xms256m -Xmx512m
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_DEV_FOLOMKIN=DEBUG
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]   # или /health, если actuator не включён
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "logging=promtail"
    networks:
      - microservices-net

  payment-db:
    image: postgres:16-alpine
    container_name: payment-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: paymentuser
      POSTGRES_PASSWORD: paymentpass456
      POSTGRES_DB: paymentdb
    ports:
      - "54323:5432"          # другой внешний порт, чтобы не конфликтовать
    volumes:
      - payment-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U paymentuser -d paymentdb"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
        - microservices-net

  # ----------------------------------------------------------------
  # Kafka
  # ----------------------------------------------------------------

  kafka-broker:
    image: bitnamilegacy/kafka:3.6
    container_name: kafka-broker
    ports:
      - "9092:9092"
    environment:
      # 1. Настройка ролей: этот контейнер и брокер, и контроллер
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      # 2. Описание портов (слушателей)
      # 9092 - для IDEA (localhost), 29092 - для Docker-сети, 9093 - внутренний для KRaft
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:29092,CONTROLLER://:9093,EXTERNAL://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-broker:29092,EXTERNAL://localhost:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      # 3. Настройка KRaft контроллера
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-broker:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      # 4. Безопасность и кластер
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/logs
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
      # - KAFKA_KRAFT_CLUSTER_ID=abcdefghijklmnopqrstuv
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
        - microservices-net

  kafka-ui:
    image: provectuslabs/kafka-ui:0.3.2
    container_name: kafka-ui
    ports:
      - "8089:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-broker:29092
      DYNAMIC_CONFIG_ENABLED: 'true'
    networks:
        - microservices-net
    # depends_on:
    #   kafka-broker:
    #     condition: service_healthy   # добавь, если у kafka есть healthcheck


  # ----------------------------------------------------------------
  # Prometheus — сбор метрик
  # ----------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.55.0   # или новее на момент чтения
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    networks:
      - microservices-net
    restart: unless-stopped
    depends_on:
      - discovery
    

  # ----------------------------------------------------------------
  # Loki — сбор и хранение логов
  # ----------------------------------------------------------------
  loki:
    image: grafana/loki:3.2.0
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki:/etc/loki
      - loki_data:/loki
    networks:
      - microservices-net
    restart: unless-stopped

  # ----------------------------------------------------------------
  # Promtail — агент, который собирает логи и отправляет в Loki
  # ----------------------------------------------------------------
  promtail:
    image: grafana/promtail:3.2.0
    container_name: promtail
    volumes:
      - ./promtail/promtail-config.yaml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - microservices-net
    restart: unless-stopped

  # ----------------------------------------------------------------
  # Grafana — визуализация метрик и логов
  # ----------------------------------------------------------------
  grafana:
    image: grafana/grafana:11.4.0   # или 12.x если уже вышла
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123   # поменяйте!
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
      - loki
    networks:
      - microservices-net
    restart: unless-stopped

volumes:
  user-db-data:
    name: user-db-data
  order-db-data:
    name: order-db-data
  payment-db-data:
    name: payment-db-data
  kafka_data:
  prometheus_data:
  grafana_data:
  loki_data:   # раскомментируйте если нужно сохранять логи


networks:
    microservices-net:
      driver: bridge